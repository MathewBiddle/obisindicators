---
title: "obisindicators"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{obisindicators}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>",
  warning  = FALSE, 
  message  = FALSE)
```

```{r setup}
library(obisindicators)
library(dplyr)
```

## Get biological occurrences

```{r occ}
occ <- occ_1M # occ_1M OR occ_SAtlantic
```

## Create a discrete global grid

Create an ISEA discrete global grid of resolution 9 using the [dggridR](https://github.com/r-barnes/dggridR) package:

```{r dgconstruct}
library(dggridR) # remotes::install_github("r-barnes/dggridR")

dggs <- dgconstruct(projection = "ISEA", topology = "HEXAGON", res = 9)
```

Here's on overview of all possible resolutions:

```{r dginfo}
inf <- dginfo(dggs)
```

Then assign cell numbers to the occurrence data:

```{r dgGEO_to_SEQNUM}
occ$cell <- dgGEO_to_SEQNUM(dggs, occ$decimalLongitude, occ$decimalLatitude)[["seqnum"]]
```

## Calculate metrics

The following function calculates the number of records, species richness, Simpson index, Shannon index, Hurlbert index (n = 50), and Hill numbers for each cell.

Perform the calculation on species level data:

```{r calc_es50}
metrics <- calc_es50(occ)
```

Add cell geometries to the metrics table:

```{r dgcellstogrid}
library(sf)

grid <- dgcellstogrid(dggs, metrics$cell) %>% 
  st_wrap_dateline() %>% 
  rename(cell = seqnum) %>% 
  left_join(
    metrics,
    by = "cell")
```

Let's check the results by creating a Shannon index map:

```{r map_gcs}
library(rnaturalearth)
library(rnaturalearthdata)
library(viridis)
library(ggplot2)

world <- ne_countries(scale = "medium", returnclass = "sf")
bb <- st_bbox(grid)

ggplot() +
  geom_sf(data = grid, aes_string(fill = "shannon", geometry = "geometry"), lwd = 0) +
  scale_fill_viridis(option = "inferno", na.value = "white", name = "Shannon index") +
  geom_sf(
    data = world, fill = "#dddddd", color = NA) +
  theme(
    panel.grid.major.x = element_blank(), 
    panel.grid.major.y = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    panel.grid.minor.y = element_blank(), 
    panel.background = element_blank(), 
    axis.text.x = element_blank(), 
    axis.text.y = element_blank(), 
    axis.ticks = element_blank(), 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank()) + 
  xlab("") + ylab("") +
  coord_sf(
    xlim = bb[c("xmin","xmax")],
    ylim = bb[c("ymin","ymax")])
```

### Map image

This creates a high resolution PNG map image.

```{r map_robin}
ggplot() +
  geom_sf(
    aes_string(fill = "n", color = "n", geometry = "geometry"),
    data = grid, lwd = 0.04) +
  scale_color_viridis(
    option = "inferno", na.value = "white", 
    name = "Number of records", trans = "log10") +
  scale_fill_viridis(
    option = "inferno", na.value = "white", 
    name = "Number of records", trans = "log10") +
  geom_sf(
    data = world, fill = "#dddddd", color = "#666666", lwd = 0.1) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(), 
    panel.background = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "bottom") +
  xlab("") + ylab("") +
  coord_sf(
    crs = "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs" )
# ggsave("map/map.png", width = 12, height = 6, dpi = 600)
```

