---
title: "obisindicators"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{obisindicators}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>",
  warning  = FALSE, 
  message  = FALSE)
```

```{r setup}
# library(obisindicators)
# devtools::load_all() # load the local version of obisindicators
library(dplyr)
```

## Get biological occurrences

Use the 1 million records subsampled from the full OBIS dataset otherwise available at https://obis.org/data/access.

```{r occ}
# occ <- occ_SAtlantic # S Atlantic
occ <- occ_1M # global 
```


## Create an H3 hexagonal grid

```{r}
# remotes::install_github("crazycapivara/h3-r")
# devtools::document() # update DESCRIPTION, NAMESPACE based on roxygen comments
# devtools::load_all() # load the local version of obisindicators
hex_res <- 2
hex <- obisindicators::make_hex_res(hex_res)
```


Then assign cell numbers to the occurrence data:

```{r dgGEO_to_SEQNUM}
occ <- occ %>% 
  mutate(
    cell = h3::geo_to_h3(
      data.frame(decimalLongitude, decimalLatitude),
      res = hex_res))
```

## Calculate indicators

The following function calculates the number of records, species richness, Simpson index, Shannon index, Hurlbert index (n = 50), and Hill numbers for each cell.

Perform the calculation on species level data:

```{r calc_indicators}
idx <- calc_indicators(occ)
```

Add cell geometries to the indicators table (`idx`):

```{r dgcellstogrid}
grid <- hex %>% 
  inner_join(
    idx,
    by = c("hexid" = "cell"))
# plot(hex_idx["sp"])
# 
# library(sf)
# 
# grid <- dgcellstogrid(h3_dggs, idx$cell) %>% 
#   st_wrap_dateline() %>% 
#   rename(cell = seqnum) %>% 
#   left_join(
#     idx,
#     by = "cell")

```

## Plot maps of indicators

Let's look at the resulting indicators in map form.

```{r map_gcs}
# ES(50)
obisindicators::gmap_indicator(grid, "es", label = "ES(50)")

# grid_0 <- grid
# grid <- grid_0
grid <- rbind(
  grid %>%
    filter(!on_dtln),
  # bind ok hex with those on dateline that we fix
  grid %>%
    filter(on_dtln) %>%
    rowwise() %>%
    mutate(
      geometry = obisindicators:::fix_dateline(geometry)))

obisindicators::gmap_indicator(grid, "es", label = "ES(50)")

obisindicators::gmap_indicator(grid, "n", label = "N")

grid %>%
  filter(!on_dtln) %>% 
  obisindicators::gmap_indicator("n", label = "N")

grid %>%
  filter(!on_dtln) %>% 
  obisindicators::gmap_indicator("es", label = "ES(50)")
```



## TODO

- [ ] fix the dateline hexagons; why not fixed with `make_hex_res()` calling `fix_dateline()`?
- [ ] what's up with no N Pacific data in global `occ_1M` subsample?

## References

* [crazycapivara/h3-r: R bindings for H3, a hierarchical hexagonal geospatial indexing system](https://github.com/crazycapivara/h3-r)
* [Introduction to H3 for R â€¢ H3 for R](https://crazycapivara.github.io/h3-r/articles/h3.html)
